# WALI API 业务状态码文档

## 概述

WALI API 使用统一的响应格式，所有接口的HTTP状态码通常为200，业务状态通过响应体中的 `code` 字段表示。

## 响应格式

```json
{
  "success": true/false,
  "code": 1,
  "message": "操作描述",
  "data": {} // 响应数据，可能为null
}
```

## 业务状态码分类

### 成功状态码

| 状态码 | 说明 |
|--------|------|
| 1 | 操作成功 |

### 通用错误码 (0-999)

| 状态码 | 说明 |
|--------|------|
| 0 | 通用业务错误 |

### 认证相关错误码 (1000-1099)

| 状态码 | 默认消息 | 说明 |
|--------|----------|------|
| 1001 | 无效的token | JWT token格式错误或签名无效 |
| 1002 | token已过期 | JWT token已过期 |
| 1003 | 缺少认证token | 请求头中未提供Authorization |
| 1004 | 登录失败 | 邮箱或密码错误 |
| 1005 | 用户不存在 | 根据token找不到对应用户 |
| 1006 | 账户已被禁用 | 用户账户被管理员禁用 |
| 1007 | 密码错误 | 密码验证失败 |

### 邮箱验证相关错误码 (1100-1199)

| 状态码 | 默认消息 | 说明 |
|--------|----------|------|
| 1101 | 邮箱域名不支持 | 邮箱域名不在允许列表中 |
| 1102 | 验证码无效 | 验证码不存在或格式错误 |
| 1103 | 验证码已过期 | 验证码超过有效期 |
| 1104 | 验证码已使用 | 验证码已被使用过 |
| 1105 | 验证码发送过于频繁 | 1分钟内重复发送 |
| 1106 | 邮件发送失败 | SMTP服务器错误或配置问题 |
| 1107 | 邮箱已被注册 | 邮箱地址已存在于系统中 |

### 用户相关错误码 (1200-1299)

| 状态码 | 默认消息 | 说明 |
|--------|----------|------|
| 1201 | 用户不存在 | 指定的用户ID不存在 |
| 1202 | 用户已存在 | 用户名或邮箱已被注册 |
| 1203 | 权限不足 | 用户无权限执行此操作 |

### Token余额相关错误码 (1300-1399)

| 状态码 | 默认消息 | 说明 |
|--------|----------|------|
| 1301 | Token余额不足 | 用户token余额不够支付操作费用 |
| 1302 | Token交易失败 | token扣除或增加操作失败 |

### 支付相关错误码 (1400-1499)

| 状态码 | 默认消息 | 说明 |
|--------|----------|------|
| 1401 | 支付服务配置不完整 | 支付平台配置缺失 |
| 1402 | 订单不存在 | 指定的订单ID不存在 |
| 1403 | 订单金额不匹配 | 支付回调金额与订单不符 |
| 1404 | 支付状态异常 | 订单状态不允许当前操作 |
| 1405 | 签名验证失败 | 支付回调签名无效 |
| 1406 | 无效的套餐类型 | 请求的套餐ID不存在 |

### 生成功能相关错误码 (1500-1599)

| 状态码 | 默认消息 | 说明 |
|--------|----------|------|
| 1501 | 任务不存在 | 指定的生成任务ID不存在 |
| 1502 | 生成失败 | AI服务生成过程失败 |
| 1503 | 生成参数无效 | 提供的生成参数格式错误 |
| 1504 | 生成服务错误 | 第三方AI服务不可用 |

### 参数验证错误码 (1600-1699)

| 状态码 | 默认消息 | 说明 |
|--------|----------|------|
| 1601 | 缺少必要参数 | 请求体中缺少必需字段 |
| 1602 | 参数无效 | 参数值不符合要求 |
| 1603 | 参数格式错误 | 参数类型或格式不正确 |

### 系统错误码 (9000-9999)

| 状态码 | 默认消息 | 说明 |
|--------|----------|------|
| 9000 | 系统内部错误 | 服务器内部未知错误 |
| 9001 | 数据库错误 | 数据库连接或查询失败 |
| 9002 | 网络错误 | 外部服务请求失败 |
| 9003 | 服务不可用 | 服务暂时不可用 |

## 使用示例

### 前端处理示例 (JavaScript)

```javascript
async function handleApiResponse(response) {
  const data = await response.json();

  if (data.success) {
    // 操作成功
    console.log('操作成功:', data.message);
    return data.data;
  } else {
    // 业务错误处理
    switch (data.code) {
      case 1001:
      case 1002:
      case 1003:
        // token相关错误，跳转登录
        redirectToLogin();
        break;

      case 1101:
        // 邮箱域名不支持
        showError('请使用QQ邮箱或Gmail注册');
        break;

      case 1301:
        // token余额不足
        showRechargeDialog(data.data);
        break;

      default:
        // 显示错误消息
        showError(data.message);
    }

    throw new Error(data.message);
  }
}

// 使用示例
try {
  const response = await fetch('/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });

  const result = await handleApiResponse(response);
  console.log('登录成功:', result);

} catch (error) {
  console.error('登录失败:', error.message);
}
```

### 错误处理最佳实践

1. **统一错误处理**: 建议在HTTP客户端层面统一处理错误码
2. **用户友好提示**: 根据错误码显示对应的用户友好消息
3. **自动重试**: 对于9000系列系统错误可考虑自动重试
4. **日志记录**: 记录错误码和详细信息用于调试

### 常见错误场景

#### 1. 未登录访问需要认证的接口
```json
{
  "success": false,
  "code": 1003,
  "message": "访问被拒绝，请提供有效的token",
  "data": null
}
```

#### 2. Token余额不足
```json
{
  "success": false,
  "code": 1301,
  "message": "Token余额不足，当前余额: 5, 需要: 20",
  "data": {
    "currentBalance": 5,
    "required": 20,
    "shortfall": 15
  }
}
```

#### 3. 邮箱域名不支持
```json
{
  "success": false,
  "code": 1101,
  "message": "暂时只支持以下邮箱注册：qq.com, gmail.com",
  "data": {
    "allowedDomains": ["qq.com", "gmail.com"]
  }
}
```

## 注意事项

1. **HTTP状态码**: 大部分业务错误HTTP状态码仍为200，只有系统级错误可能返回5xx
2. **向下兼容**: 保留了`success`字段以兼容现有前端代码
3. **扩展性**: 错误码按功能模块分段，便于后续扩展
4. **多语言**: 错误消息可根据请求头中的语言设置返回不同语言版本